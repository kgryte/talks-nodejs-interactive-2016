<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">

	<title>Talk | Node.js Interactive 2016 | Math in V8 is Broken and How We Can Fix It</title>

	<meta name="description" content="The built-in JavaScript Math library is used in virtually every Node.js application, from generating random ids to calculating exponential back-off times to computing basic performance metrics. When using the Math library, most developers simply assume that the underlying implementations are accurate, performant, and correctly implemented. In this presentation, I discuss why this assumption is often false and show the various ways in which the standard library is broken. The presentation includes the algorithms used, their performance and accuracy, and how they have downstream effects on users of these libraries. The presentation concludes by highlighting how community solutions are stepping up to fix these problems and identity opportunities for additional improvements.">
	<meta name="author" content="Athan Reines">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

	<link rel="stylesheet" href="css/grid.css">
	<link rel="stylesheet" href="css/font-awesome.css">
	<link rel="stylesheet" href="css/reveal.css">
	<link rel="stylesheet" href="css/theme/white.css">
	<link rel="stylesheet" href="css/style.css">

	<!-- Code syntax highlighting -->
	<link rel="stylesheet" href="css/code/zenburn.css">

	<!-- Printing and PDF exports -->
	<script src="js/lib/reveal/pdf.js"></script>

	<!--[if lt IE 9]>
	<script src="js/lib/reveal/html5shiv.js"></script>
	<![endif]-->
</head>

<body>

	<div class="reveal">

		<!-- Any section element inside of this container is displayed as a slide -->
		<div class="slides">
			<section data-background="img/title_slide_bkgd.jpg">
				<aside class="notes">

				</aside>
			</section>

			<section class="center" id="title-slide-part-1">
				<h1>Math in V8 is Broken</h1>
				<p>
					<small><a href="https://github.com/kgryte"><i class="fa fa-github"></i> Athan Reines</a> / <a href="https://twitter.com/kgryte"><i class="fa fa-twitter"></i> @kgryte</a></small>
				</p>

				<aside class="notes">
					<p>
						Hi! Thank you for coming to this talk.
					</p>
					<p>
						I am here today to talk about math. I should not that, while the title of this talk explicitly mentions V8, much of the content applies to other JavaScript engines, as well. And further, the concept that math is broken extends beyond any particular engine and also includes JavaScript at the specification level.
					</p>
					<p>
						Without further ado...
					</p>
				</aside>
			</section>

			<section class="center">
				<h2>Standard Library</h1>

				<aside class="notes">
					<p>
						The JavaScript standard library is often a developer's first introduction to math in JavaScript and its math functions are commonly used in JavaScript applications.
					</p>
					<p>
						To review...
					</p>
				</aside>
			</section>

			<section class="center">
				<h2>ES5</h2>

				<div class="row">
					<ul class="fragment column column-3">
						<li>acos</li>
						<li>asin</li>
						<li>atan</li>
						<li>atan2</li>
						<li>cos</li>
						<li>sin</li>
						<li>tan</li>
					</ul>
					<ul class="fragment column column-3">
						<li>abs</li>
						<li>exp</li>
						<li>log (ln)</li>
						<li>pow</li>
						<li>sqrt</li>
					</ul>
					<ul class="fragment column column-3">
						<li>ceil</li>
						<li>floor</li>
						<li>round</li>
					</ul>
					<ul class="fragment column column-2">
						<li>max</li>
						<li>min</li>
						<li>random</li>
					</ul>
				</div>

				<aside class="notes">
					<p>
						In ES5, the standard math library consisted of 18 functions and 8 constants. These functions can be categorized as trigonometric, other special functions, including rounding, and miscellaneous, including a PRNG.
					</p>
				</aside>
			</section>

			<!-- <section class="center">
				<h2>ES5</h2>

				<div class="row">
					<div class="column column-4">&nbsp;</div>
					<ul class="column column-3">
						<li>E</li>
						<li>LN2</li>
						<li>LN10</li>
						<li>LOG2E</li>
					</ul>
					<ul class="column column-3">
						<li>LOG10E</li>
						<li>PI</li>
						<li>SQRT1_2</li>
						<li>SQRT2</li>
					</ul>
				</div>

				<aside class="notes">
					<ul>
						<li>8 constants</li>
					</ul>
				</aside>
			</section> -->

			<section class="center">
				<h2>ES2015/ES6</h2>

				<div class="row">
					<ul class="fragment column column-3">
						<li>acosh</li>
						<li>asinh</li>
						<li>atanh</li>
						<li>cosh</li>
						<li>sinh</li>
						<li>tanh</li>
					</ul>
					<ul class="fragment column column-3">
						<li>sign</li>
						<li>cbrt</li>
						<li>expm1</li>
						<li>log10</li>
						<li>log1p</li>
						<li>log2</li>
					</ul>
					<ul class="fragment column column-3">
						<li>fround</li>
						<li>trunc</li>
					</ul>
					<ul class="fragment column column-2">
						<li>hypot</li>
						<li>clz32</li>
						<li>imul</li>
					</ul>
				</div>

				<aside class="notes">
					<p>
						ES2015/ES6 added 17 more functions to the standard math library. Again, these functions are broken down into trigonometric, other special functions, including rounding, and miscellaneous.
					</p>
					<p>
						The addition of these 17 functions means the JavaScript standard math library has 35 functions.
					</p>
				</aside>
			</section>

			<section class="center">
				<h2>Comparison</h1>

				<aside class="notes">
					<p>
						For comparison, let us compare the JavaScript standard Math library to another language.
					</p>
				</aside>
			</section>

			<section class="center">
				<h2>Golang</h2>

				<div class="row">
					<ul class="fragment column column-3">
						<li>Abs</li>
						<li>Acosh</li>
						<li>Asin</li>
						<li>Asinh</li>
						<li>Atan</li>
						<li>Atan2</li>
						<li>Atanh</li>
						<li>Cbrt</li>
						<li>Ceil</li>
						<li>Copysign</li>
					</ul>
					<ul class="fragment column column-3">
						<li>Cos</li>
						<li>Cosh</li>
						<li>Dim</li>
						<li>Erf</li>
						<li>Erfc</li>
						<li>Exp</li>
						<li>Exp2</li>
						<li>Expm1</li>
						<li>Float32bits</li>
						<li>Float64bits</li>
					</ul>
					<ul class="fragment column column-3">
						<li>Floor</li>
						<li>Frexp</li>
						<li>Gamma</li>
						<li>Hypot</li>
						<li>Ilogb</li>
						<li>J0</li>
						<li>J1</li>
						<li>Jn</li>
						<li>Ldexp</li>
						<li>Lgamma</li>
					</ul>
					<ul class="fragment column column-2">
						<li>Log</li>
						<li>Log10</li>
						<li>Log1p</li>
						<li>Log2</li>
						<li>Logb</li>
						<li>Max</li>
						<li>Min</li>
						<li>Mod</li>
						<li>Modf</li>
						<li>Nextafter</li>
					</ul>
				</div>

				<aside class="notes">
					<p>
						Once again, we find trigonometric functions, various other special functions, and lower level functions for manipulating and generating floating-point numbers.
					</p>
				</aside>
			</section>

			<section class="center">
				<h2>Golang</h2>

				<div class="row">
					<ul class="fragment column column-3">
						<li>NextAfter32</li>
						<li>Pow</li>
						<li>Pow10</li>
						<li>Signbit</li>
						<li>Sin</li>
						<li>Sincos</li>
						<li>Sinh</li>
						<li>Sqrt</li>
						<li>Tan</li>
						<li>Tanh</li>
					</ul>
					<ul class="fragment column column-3">
						<li>Trunc</li>
						<li>Y0</li>
						<li>Y1</li>
						<li>Yn</li>
						<li>ExpFloat64</li>
						<li>Float64</li>
						<li>Int</li>
						<li>Int63</li>
						<li>NormFloat64</li>
						<li>Perm</li>
					</ul>
					<ul class="fragment column column-3">
						<li>Uint32</li>
						<li>Zipf</li>
						<li>(Complex)</li>
						<li>(Big)</li>
					</ul>
				</div>

				<aside class="notes">
					<p>
						In total, the Golang standard math library has 54 functions (JS has 35), 8+ PRNGs, as well as support for 64-bit and 128-bit complex numbers. Notably, Golang has equivalents for most C/C++ standard math library functions.
					</p>
				</aside>
			</section>

			<section class="center">
				<h2>Bugs</h1>

				<aside class="notes">
					<p>
						Bugs.
					</p>
				</aside>
			</section>

			<section class="center">
				<h2>Node v0.10</h1>

				<aside class="notes">

				</aside>
			</section>

			<section class="center">
				<pre><code class="hljs javascript" contenteditable>
sin(-0) == 0      // wrong (IEEE 754)
NaN == NaN        // distinguishable NaNs
				</code></pre>

				<aside class="notes">
					<ul>
						<li>Sine is an odd function.</li>
						<li>On some Windows systems, can manipulate the bit sequence within typed arrays to generate a distinguishable NaN. See also <a href="https://github.com/tc39/ecma262/issues/635">"Canonical NaNs"</a> and <a href="https://github.com/ljharb/get-nans/blob/master/index.js">get-nans</a></li>
					</ul>
				</aside>
			</section>

			<section>
				<!-- Add blank slide to separate main presentation from appendix -->
				<aside class="notes">
					Intentionally left blank.
				</aside>
			</section>

			<section class="center">
				<h2>Appendix</h2>
			</section>

			<section class="center">
				<!-- Intentionally many lines -->
				<pre><code class="hljs javascript" contenteditable>




















				</code></pre>
				<aside class="notes">
					Slide for code editing.
				</aside>
			</section>

			<section class="center">
				<h2>What can be done at the specification level?</h2>

				<aside class="notes">

				</aside>
			</section>

			<section class="center">
				<ul>
					<li class="fragment">
						<a href="https://developer.mozilla.org/en-US/docs/Mozilla/js-ctypes/js-ctypes_reference/Int64">Int64</a> (and bitwise ops)
					</li>
					<li class="fragment">
						<a href="http://wiki.ecmascript.org/doku.php?id=harmony:typed_objects">Typed Objects</a>
					</li>
					<li class="fragment">
						<a href="https://en.wikipedia.org/wiki/WebCL">WebCL</a>
					</li>
					<li class="fragment">
						<a href="https://hacks.mozilla.org/2014/10/introducing-simd-js/">SIMD (long)</a>
					</li>
					<li class="fragment">
						<a href="http://www.2ality.com/2013/12/paralleljs.html">Parallel Computing</a>
					</li>
					<li class="fragment">
						<a href="http://www.2ality.com/2011/12/fake-operator-overloading.html">Operator Overloading</a>
					</li>
					<li class="fragment">
						<a href="https://medium.com/javascript-scene/why-we-need-webassembly-an-interview-with-brendan-eich-7fb2a60b0723#.8cos1ynh1">Web Assembly</a>
					</li>
				</ul>

				<aside class="notes">
					<ul>
						<li>Counting things, 64bit IDs which are not strings, money,...</li>
						<li>Efficient serialization</li>
						<li>GPGPU</li>
						<li>Current support is for short SIMD, which is good for games and image processing, but less so for large vectors.</li>
						<li>Lightweight threading model (similar to Go), rather than IPC</li>
						<li>Allows for more compact syntax (MATLAB)</li>
						<li>While most of the time, coding algos in JS should suffice, a compilation target for performance critical code will be awesome to have.</li>
					</ul>
				</aside>
			</section>

			<section class="center">
				<h2>Integer Support</h2>
				<ul>
					<li>
						<a href="https://esdiscuss.org/topic/efficient-64-bit-arithmetic#content-7">discussion</a>
					</li>
					<li>
						<a href="https://gist.github.com/BrendanEich/4294d5c212a6d2254703">gist</a>
					</li>
					<li>
						<a href="http://www.r-bloggers.com/r-in-a-64-bit-world/">Int64 in R</a>
					</li>
				</ul>
			</section>

			<section class="center">
				<h2>Typed Objects</h2>
				<ul>
					<li>
						<a href="https://github.com/dslomov/typed-objects-es7">spec</a>
					</li>
					<li>
						<a href="https://github.com/nikomatsakis/typed-objects-explainer/">explainer</a>
					</li>
					<li>
						<a href="http://dave.cheney.net/2014/06/07/five-things-that-make-go-fast">typed data structures in Go</a>
					</li>
				</ul>
			</section>

			<section class="center">
				<h2>WebCL</h2>
				<ul>
					<li>
						<a href="https://github.com/mikeseven/node-opencl">node-opencl</a>
					</li>
			</section>

			<section class="center">
				<h2>SIMD</h2>
				<ul>
					<li>
						<a href="https://github.com/tc39/ecmascript_simd/blob/master/src/ecmascript_simd.js">polyfill</a>
					</li>
					<li>
						<a href="https://01.org/blogs/tlcounts/2014/bringing-simd-javascript">Intel announcement</a>
					</li>
					<li>
						<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SIMD">MDN</a>
					</li>
					<li>
						<a href="https://docs.google.com/presentation/d/1MY9NHrHmL7ma7C8dyNXvmYNNGgVmmxXk8ZIiQtPlfH4/edit#slide=id.p19">presentation</a>
					</li>
				</ul>
			</section>

			<section class="center">
				<h2>Parallel Computing</h2>
				<ul>
					<li>
						<a href="https://en.wikipedia.org/wiki/Data_parallelism">Data parallelism</a>
					</li>
					<li>
						<a href="https://en.wikipedia.org/wiki/Task_parallelism">Task parallelism</a>
					</li>
					<li>
						<a href="http://smallcultfollowing.com/babysteps/blog/2012/01/09/parallel-javascript/">Scheduler</a>
					</li>
					<li>
						<a href="http://preshing.com/20120612/an-introduction-to-lock-free-programming/">Lock-free programming</a>
					</li>
					<li>
						<a href="https://github.com/lars-t-hansen/ecmascript_sharedmem/blob/master/TUTORIAL.md">Shared Memory Web Workers</a>
					</li>
				</ul>
			</section>

			<section class="center">
				<h2>Operator Overloading</h2>
				<ul>
					<li>
						<a href="https://github.com/kushal-likhi/operator-overloading-js">operator-overloading-js</a>
					</li>
					<li>
						<a href="http://scratchdisk.com/posts/operator-overloading">paper.js</a>
					</li>
					<li>
						<a href="https://github.com/paperjs/paper.js/blob/master/src/core/PaperScript.js">paper.js source</a>
					</li>
				</ul>
			</section>

			<section class="center">
				<h2>The End</h2>
			</section>

		</div>

	</div>

	<script src="js/lib/reveal/head.min.js"></script>
	<script src="js/lib/reveal/reveal.js"></script>
	<script src="js/lib/reveal/init.js"></script>
	<script src="js/script.js"></script>
</body>
</html>
